<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IntelliFit</title>
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/libs/apexcharts/dist/apexcharts.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
<div class="page">
  <header class="navbar navbar-expand-sm navbar-light d-print-none">
    <div class="container-xl">
      <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
        <a href="#">
          <img src="/image/Logo2.png" width="175" height="71" alt="IntelliFit" class="navbar-brand-image" />
        </a>
      </h1>

      <div class="navbar-nav flex-row order-md-last">
        <div class="nav-item" style="margin-right: 5px">
          <div class="dropdown">
            <a  class="btn dropdown-toggle " data-bs-toggle="dropdown">About</a>
            <div class="dropdown-menu">
              <h3 class="text; text-center">Developers</h3>
              <div class="dropdown-divider"></div>
              <h3 class="text-muted; text-center">Junwei Liao</h3>
              <h3 class="text-muted; text-center">Yifeng Zhang</h3>
              <h3 class="text-muted; text-center">Chenfeng Li</h3>
              <h3 class="text-muted; text-center">Bingsong Tong</h3>
              <h3 class="text-muted; text-center">Xiaozhi Wan</h3>
            </div>
          </div>

        </div>
        <div class="nav-item">
          <button type="button" class="btn btn-yellow" onclick="Logout()">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-logout" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2"></path>
              <path d="M9 12h12l-3 -3"></path>
              <path d="M18 15l3 -3"></path>
            </svg>
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>
  <div class="page-wrapper">
    <div class="page-body">
      <div class="container-xl">
        <div class="row row-deck row-cards">
          <div class="col-4">
            <div class="card">
              <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-info-square" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M12 9h.01"></path>
                  <path d="M3 5a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v14a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-14z"></path>
                  <path d="M11 12h1v4h1"></path>
                </svg>
                <h2 style="margin-top: 6px">User Information</h2>

              </div>
              <div class="card-body" >
                <div class="hr-text hr-text-left" style="margin-top: 0rem">Name</div>
                <h1 class="text-muted" style="margin: 0.8rem;text-align: center"><span id="Infousername">0.00</span></h1>
                <div class="hr-text hr-text-left">Height</div>
                <h1 class="text-muted" style="margin: 0.8rem;text-align: center"><span id="Infoheight">0.00</span> m</h1>
                <div class="hr-text hr-text-left">Weight</div>
                <h1 class="text-muted" style="margin: 0.8rem;text-align: center"><span id="Infoweight">0.00</span> kg</h1>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card">
              <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-redux" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M16.54 7c-.805 -2.365 -2.536 -4 -4.54 -4c-2.774 0 -5.023 2.632 -5.023 6.496c0 1.956 1.582 4.727 2.512 6"></path>
                  <path d="M4.711 11.979c-1.656 1.877 -2.214 4.185 -1.211 5.911c1.387 2.39 5.138 2.831 8.501 .9c1.703 -.979 2.875 -3.362 3.516 -4.798"></path>
                  <path d="M15.014 19.99c2.511 0 4.523 -.438 5.487 -2.1c1.387 -2.39 -.215 -5.893 -3.579 -7.824c-1.702 -.979 -4.357 -1.235 -5.927 -1.07"></path>
                  <path d="M10.493 9.862c.48 .276 1.095 .112 1.372 -.366a1 1 0 0 0 -.367 -1.365a1.007 1.007 0 0 0 -1.373 .366a1 1 0 0 0 .368 1.365z"></path>
                  <path d="M9.5 15.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                  <path d="M15.5 14m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                </svg>
                <h2 style="margin-top: 6px">Environment</h2>
              </div>
              <div class="card-body" >
                  <div class="hr-text hr-text-left" style="margin-top: 0rem">Temperature</div>
                  <h1 class="text-muted" style="margin: 0.8rem;text-align: center"><span id="temp-display">N/A</span> °C</h1>
                <div class="hr-text hr-text-left">Humidity</div>
                  <h1 class="text-muted" style="margin: 0.8rem;text-align: center"><span id="humid-display">N/A</span> %RH</h1>
                <div class="hr-text hr-text-left">Posture Status</div>
                  <h1 class="text-muted" style="margin: 0.8rem;text-align: center">
                    <span class="badge bg-lime" hidden id="span1">Correct</span>
                    <span class="badge bg-red" hidden id="span2">Incorrect</span>
                    <span class="badge bg-secondary" hidden id="span3">No Data</span>
                  </h1>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card">
              <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chart-pie-3" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M12 12l-6.5 5.5"></path>
                  <path d="M12 3v9h9"></path>
                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                </svg>
                <h2 style="margin-top: 6px">Status</h2>
              </div>
              <div class="card-body" style="height: 20rem">
                <div id="chart-demo-pie" style="margin-top: 60px" class="chart-lg"></div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="card">
              <div class="card-body" style="height: 25rem">
                <div id="carousel-sample" class="carousel slide" data-bs-ride="carousel">
                  <div class="carousel-indicators">
                    <button type="button" data-bs-target="#carousel-sample" data-bs-slide-to="0" class="active"></button>
                    <button type="button" data-bs-target="#carousel-sample" data-bs-slide-to="1"></button>
                    <button type="button" data-bs-target="#carousel-sample" data-bs-slide-to="2"></button>
                    <button type="button" data-bs-target="#carousel-sample" data-bs-slide-to="3"></button>
                    <button type="button" data-bs-target="#carousel-sample" data-bs-slide-to="4"></button>
                  </div>
                  <div class="carousel-inner">
                    <div class="carousel-item active">
                      <img class="d-block w-100" alt="1" src="/image/example photo1.jpg" />
                    </div>
                    <div class="carousel-item">
                      <img class="d-block w-100" alt="2" src="/image/example photo2.jpg" />
                    </div>
                    <div class="carousel-item">
                      <img class="d-block w-100" alt="3" src="/image/example photo3.jpg" />
                    </div>
                    <div class="carousel-item">
                      <img class="d-block w-100" alt="4" src="/image/example photo4.jpg" />
                    </div>
                    <div class="carousel-item">
                      <img class="d-block w-100" alt="5" src="/image/example photo5.jpg" />
                    </div>
                  </div>
                  <a class="carousel-control-prev" data-bs-target="#carousel-sample" role="button" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                  </a>
                  <a class="carousel-control-next" data-bs-target="#carousel-sample" role="button" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
          <div class="col-6">

            <div class="card">
              <div class="card-body" style="height: 10rem">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="subheader">Status monitoring</div>
                  </div>
                  <div class="d-flex align-items-baseline">
                    <div class="h1 mb-3 me-2">Postural correctness:&nbsp;&nbsp;<span id="correctper">N/A</span> %</div>
                  </div>
                  <div class="mt-2">
                    <div class="tracking">
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                      <div class="tracking-block" data-bs-toggle="tooltip" data-bs-placement="top"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3 class="card-title; text-center" style="font-size: 25px ">Advices</h3>
                </div>
                <div class="card-body">
                  <div class="alert alert-success" role="alert">
                    <h4 class="alert-title" style="font-size: 18px">Little Tips</h4>
                    <h3 class="text-muted"><span id="advice-display"></span></h3>
                  </div>
                </div>
              </div>
              </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const uid = '1';  // Replace this with a valid UID
  const ws = new WebSocket(`ws://localhost:80/conn/${uid}`);
  let Correctcount = 0
  let Incorrectcount = 0
  let NoDatacount = 0
  let chart = new ApexCharts(document.getElementById('chart-demo-pie'), {
    chart: {
      type: "donut",
      height: 240,
      sparkline: {
        enabled: true
      },
      animations: {
        enabled: false
      },
    },
    fill: {
      opacity: 1,
    },
    series: [
      Correctcount,
      Incorrectcount,
      NoDatacount
    ],
    labels: ["Correct(%)", "Incorrect(%)", "No Data(%)"],
    tooltip: {
      fillSeriesColor: false,
      style: {
        fontSize: '20px'
      },
      theme: 'dark'
    },
    grid: {
      strokeDashArray: 4,
    },
    colors: [tabler.getColor("green",1), tabler.getColor("red", 1), tabler.getColor("gray", 0.2), tabler.getColor("gray-300")],
    legend: {
      show: true,
      position: 'bottom',
      offsetY: 12,
      markers: {
        width: 20,
        height: 20,
        radius: 600,
      },
      itemMargin: {
        horizontal: 8,
        vertical: 8
      },
    },
  })
  window.onload = chart.render()
  window.onload  = getUserInfo;
  function getUserInfo() {

    let xhr = new XMLHttpRequest();
    xhr.open('GET', '/userInfo', true);
    xhr.onload = function () {
      let data = JSON.parse(xhr.response);
      console.log(data);
      if(data.code === 1){
        let nameElement = document.getElementById('Infousername');
        let weightElement = document.getElementById('Infoweight');
        let heightElement = document.getElementById('Infoheight');

        nameElement.innerText = data.data.username;
        weightElement.innerText = data.data.weight;
        heightElement.innerText = data.data.height;
      }
      else {
        window.location.href = '/Login.html';
      }
    };
    xhr.send();
  }

  function Logout(){
    let xhr = new XMLHttpRequest();
    xhr.open('GET','/userLogout',true)
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send()
    xhr.onload = function() {
      let data = JSON.parse(xhr.response);
      if(data.code === 1) {
        // 登录成功
        console.log(data);
        window.location.href = '/Login.html';
      }
    }
  }

  ws.onerror = (error) => {
    console.log('WebSocket error:', error);
  };

  const span1 = document.getElementById('span1');
  const span2 = document.getElementById('span2');
  const span3 = document.getElementById('span3');
  ws.onmessage = function(event) {
    let data = JSON.parse(event.data);
    console.log(data);
    if(data.msg ==="send advice"){
      document.getElementById('advice-display').textContent = data.data;
    } else if (data.msg === "send temp") {
      document.getElementById('temp-display').textContent = data.data;
    } else if (data.msg === "send humid") {
      document.getElementById('humid-display').textContent = data.data;
    } else if (data.msg === "send status") {
      if(data.data === 0){
        span1.hidden = true;
        span2.hidden = false;
        span3.hidden = true;
        Incorrectcount++;
      }else if(data.data === 1){
        span1.hidden = false;
        span2.hidden = true;
        span3.hidden = true;
        Correctcount++;
      }else {
        span1.hidden = true;
        span2.hidden = true;
        span3.hidden = false;
        NoDatacount++;
      }
      updateTracker(data.data);
    }
    let CorrectPer = parseFloat((Correctcount / (Correctcount + Incorrectcount + NoDatacount) * 100).toFixed(2));
    let InCorrectPer = parseFloat((Incorrectcount / (Correctcount + Incorrectcount + NoDatacount) * 100).toFixed(2));
    let NoDataPer = parseFloat((NoDatacount / (Correctcount + Incorrectcount + NoDatacount) * 100).toFixed(2));
    document.getElementById('correctper').textContent = ((Correctcount / (Correctcount + Incorrectcount + NoDatacount) * 100).toFixed(2));
            console.log(Incorrectcount.toString(),Correctcount.toString(),NoDatacount.toString());
    console.log(CorrectPer.toString(),InCorrectPer.toString(),NoDataPer.toString())
    let newData = [CorrectPer,InCorrectPer,NoDataPer];
    chart.updateSeries(newData);
  };
  function updateTracker(newStatus) {
    let tag;
    if (newStatus === 0){
      tag = 'bg-danger'
    }else if(newStatus === 1 ){
      tag = 'bg-success'
    }else {
      tag = 'bg-grey-50'
    }


    // 获取所有 tracking-block 元素
    const blocks = document.querySelectorAll('.tracking-block');


    // 其余的 block 向后顺延一个
    for(let i = blocks.length-1; i > 0; i--) {
      blocks[i].className = blocks[i-1].className;
    }
    // 将新的状态添加到第一个 block
    blocks[0].className = `tracking-block ${tag}`;
    console.log(blocks)
  }
</script>
</body>
<style>
  body {
    background-color: rgba(246, 103, 7, 0.59);  /* a light grey color */
  }
  .hr-text .hr-text-left .hr-text-left-top{

  }
</style>
</html>